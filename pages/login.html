<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Devine Water — Login</title>
    <link rel="stylesheet" href="../assets/css/login.css" />
  </head>
  <body>
    <div class="login-container">
      <div class="login-background"></div>
      <div class="login-card">
        <div class="login-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color:white;margin:0 auto 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2.25c5.385 0 9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12 6.615 2.25 12 2.25z"/>
          </svg>
          <h1>Devine Water</h1>
          <p>Pure. Fresh. Divine.</p>
        </div>

        <div class="login-tabs">
          <button id="tab-admin" class="active">Admin</button>
          <button id="tab-customer">Customer</button>
        </div>

        <div class="login-form">
          <div>
            <label id="label-username">Username</label>
            <input type="text" id="login-username" placeholder="admin" />
          </div>
          <div>
            <label>Password</label>
            <div class="password-input-container">
              <input type="password" id="login-password" placeholder="Enter password" />
              <button type="button" id="toggle-password" class="password-toggle-btn">Show</button>
            </div>
          </div>
          <div id="error" class="error-message" style="display:none;"></div>
          <button id="login-btn" class="login-button">Login</button>
          <div id="admin-help" class="admin-help">
            <p>Default: admin / admin</p>
            <button id="open-admin-settings">Change Password</button>
          </div>
        </div>
      </div>

      <div id="admin-settings" class="modal-overlay" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Admin Settings</h2>
            <button id="close-admin-settings">✕</button>
          </div>
          <div class="modal-body">
            <div>
              <label>Username</label>
              <input type="text" id="admin-username" disabled />
            </div>
            <div>
              <label>New Password</label>
              <input type="password" id="admin-new-password" placeholder="Enter new password" />
            </div>
            <button id="save-admin-password" class="modal-button">Update Password</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { state, setUserType, setCurrentUser } from '../assets/js/state.js';
      const tabAdmin = document.getElementById('tab-admin');
      const tabCustomer = document.getElementById('tab-customer');
      const labelUsername = document.getElementById('label-username');
      const usernameInput = document.getElementById('login-username');
      const passwordInput = document.getElementById('login-password');
      const togglePassword = document.getElementById('toggle-password');
      const errorEl = document.getElementById('error');
      const loginBtn = document.getElementById('login-btn');
      const adminHelp = document.getElementById('admin-help');
      const adminModal = document.getElementById('admin-settings');
      const openAdminModal = document.getElementById('open-admin-settings');
      const closeAdminModal = document.getElementById('close-admin-settings');
      const adminUsername = document.getElementById('admin-username');
      const adminNewPassword = document.getElementById('admin-new-password');
      const saveAdminPassword = document.getElementById('save-admin-password');

      let loginType = 'admin';

      function setError(msg) { errorEl.style.display = msg ? 'block' : 'none'; errorEl.textContent = msg || ''; }
      function switchToAdmin() {
        loginType = 'admin';
        tabAdmin.classList.add('active');
        tabCustomer.classList.remove('active');
        labelUsername.textContent = 'Username';
        usernameInput.placeholder = 'admin';
        adminHelp.style.display = 'block';
        setError('');
      }
      function switchToCustomer() {
        loginType = 'customer';
        tabCustomer.classList.add('active');
        tabAdmin.classList.remove('active');
        labelUsername.textContent = 'Phone Number';
        usernameInput.placeholder = '03XX-XXXXXXX';
        adminHelp.style.display = 'none';
        setError('');
      }

      tabAdmin.addEventListener('click', switchToAdmin);
      tabCustomer.addEventListener('click', switchToCustomer);

      togglePassword.addEventListener('click', () => {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        togglePassword.textContent = passwordInput.type === 'password' ? 'Show' : 'Hide';
      });

      loginBtn.addEventListener('click', () => {
        setError('');
        const u = usernameInput.value.trim();
        const p = passwordInput.value.trim();
        if (!u || !p) { setError('Please enter all credentials'); return; }

        if (loginType === 'admin') {
          if (u === state.adminCredentials.username && p === state.adminCredentials.password) {
            setUserType('admin');
            window.location.href = './admin/dashboard.html';
          } else { setError('Invalid admin credentials!'); }
        } else {
          const customer = state.customers.find(c => c.phone === u && c.password === p);
          if (customer) {
            setCurrentUser(customer);
            setUserType('customer');
            window.location.href = './customer/dashboard.html';
          } else { setError('Invalid customer credentials!'); }
        }
      });

      // Admin settings modal
      openAdminModal.addEventListener('click', () => {
        adminUsername.value = state.adminCredentials.username;
        adminModal.style.display = 'flex';
      });
      closeAdminModal.addEventListener('click', () => { adminModal.style.display = 'none'; });
      saveAdminPassword.addEventListener('click', () => {
        const newPass = adminNewPassword.value.trim();
        if (newPass.length < 4) { setError('Password must be at least 4 characters long'); return; }
        state.adminCredentials.password = newPass;
        setError('');
        adminModal.style.display = 'none';
        alert('Admin password updated successfully!');
      });

      // Enter to submit
      [usernameInput, passwordInput].forEach(el => el.addEventListener('keypress', e => { if (e.key === 'Enter') loginBtn.click(); }));
    </script>
  </body>
</html>