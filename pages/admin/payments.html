<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Payments</title>
  <link rel="stylesheet" href="../../assets/css/base.css" />
  <script src="../../config.js"></script>
</head>

<body>
  <div id="navbar"></div>
  <main class="min-h-screen bg-gray-50">
    <div class="container py-8">
      <div class="flex justify-between items-center mb-6">
        <button class="text-cyan-600 font-semibold" onclick="location.href='./dashboard.html'">← Back to
          Dashboard</button>
        <button id="btn-add-payment" class="btn btn-green">➕ Add Payment</button>
      </div>

      <h2 class="text-4xl font-bold text-cyan-600 mb-6">Payment Management</h2>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-body">
            <h3 class="text-2xl font-bold mb-4" style="color:#b91c1c">Unpaid Customers</h3>
            <div id="unpaid-list" class="space-y-4"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h3 class="text-2xl font-bold mb-4" style="color:#14532d">Recent Payments</h3>
            <div id="payments-list" class="space-y-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderNavbar, initPage, showAlert, showConfirm, showFormDialog, showMessagingOptions } from '../../assets/js/ui.js';
    import { state, recordPayment } from '../../assets/js/state.js';
    import { calculateMonthlyBill, calculateBalance, checkRenewalStatus, normalizePhoneNumber } from '../../assets/js/utils.js';

    const unpaidList = document.getElementById('unpaid-list');
    const paymentsList = document.getElementById('payments-list');

    // Initialize page with auth check
    if (!await initPage({ requireAdmin: true })) {
      // Redirect handled by initPage
    } else {
      renderUnpaid();
      renderPayments();
    }

    function renderUnpaid() {
      const unpaidCustomers = state.customers.filter(c => !c.isPaid || checkRenewalStatus(c));
      if (unpaidCustomers.length === 0) { unpaidList.innerHTML = '<p class="text-gray-500">All paid!</p>'; return; }
      unpaidList.innerHTML = unpaidCustomers.map(customer => {
        const monthlyBill = calculateMonthlyBill(customer);
        const balance = calculateBalance(customer, state.payments);
        const totalPaid = monthlyBill - balance;
        const isPartiallyPaid = totalPaid > 0 && balance > 0;

        return `
          <div class="bg-red-50 p-5 rounded-xl border">
            <div class="flex justify-between mb-3">
              <div>
                <p class="font-bold text-xl">${customer.name}</p>
                <p class="text-sm text-gray-600">${customer.phone}</p>
                ${isPartiallyPaid ? `<p class="text-sm text-orange-600 font-semibold mt-1">Paid: Rs. ${totalPaid} / ${monthlyBill}</p>` : ''}
              </div>
              <div class="text-right">
                <p class="text-3xl font-bold text-red-600">Rs. ${balance}</p>
                <p class="text-xs text-gray-500">Balance</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-secondary" data-wa="${customer.id}">Send Reminder</button>
              <button class="btn btn-green" data-paid="${customer.id}">Mark Paid</button>
            </div>
          </div>
        `;
      }).join('');
      Array.from(document.querySelectorAll('[data-wa]')).forEach(b => {
        b.addEventListener('click', async () => {
          const id = Number(b.getAttribute('data-wa'));
          const c = state.customers.find(x => x.id === id);
          const balance = calculateBalance(c, state.payments);
          const msg = `Dear ${c.name}, your payment of Rs. ${balance} is due. Renewal: ${c.renewalDate}. Thank you! - Devine Water`;

          const choice = await showMessagingOptions(c.name, c.phone, msg);
          if (choice === 'whatsapp') {
            const phone = normalizePhoneNumber(c.phone, true);
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
          } else if (choice === 'sms') {
            const phone = normalizePhoneNumber(c.phone, false);
            const url = `sms:${phone}?body=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
          }
        });
      });
      Array.from(document.querySelectorAll('[data-paid]')).forEach(b => {
        b.addEventListener('click', async () => {
          const id = Number(b.getAttribute('data-paid'));
          const c = state.customers.find(x => x.id === id);
          const balance = calculateBalance(c, state.payments);
          const confirmed = await showConfirm(`Confirm payment Rs. ${balance} for ${c.name}?`, 'Confirm Payment');
          if (confirmed) {
            try {
              await recordPayment(id, balance, 'Cash');
              await showAlert('Payment recorded successfully!', 'Success');
              renderPayments();
              renderUnpaid();
            } catch (err) {
              await showAlert(`Failed to record payment: ${err.message}`, 'Error');
            }
          }
        });
      });
    }

    function renderPayments() {
      if (state.payments.length === 0) { paymentsList.innerHTML = '<p class="text-gray-500">No payments yet</p>'; return; }

      // Sort by date descending (newest first)
      const sortedPayments = [...state.payments].sort((a, b) => new Date(b.date) - new Date(a.date));

      paymentsList.innerHTML = sortedPayments.slice(0, 10).map(p => `
          <div class="bg-white p-5 rounded-xl border hover-lift flex justify-between items-center">
            <div class="flex items-center gap-4">
              <div class="bg-green-100 p-3 rounded-full text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <p class="font-bold text-lg">${p.customerName || 'Unknown Customer'}</p>
                <p class="text-sm text-gray-500">${p.date} • ${p.method || 'Cash'}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-2xl font-bold text-green-600">Rs. ${p.amount}</p>
              <span class="badge badge-paid text-xs">Paid</span>
            </div>
          </div>
        `).join('');
    }

    document.getElementById('btn-add-payment').addEventListener('click', async () => {
      // Check if there are any customers
      if (!state.customers || state.customers.length === 0) {
        await showAlert('No customers found. Please add customers first before recording payments.', 'No Customers');
        return;
      }

      const result = await showFormDialog('Add New Payment', [
        { name: 'customerId', label: 'Customer', type: 'select', required: true },
        { name: 'amount', label: 'Amount (Rs)', type: 'number', min: 0, step: '0.01', placeholder: 'Enter amount', required: true },
        { name: 'method', label: 'Payment Method', type: 'select', options: ['Cash', 'Online', 'Bank Transfer'], required: true }
      ], state.customers);

      if (result) {
        try {
          await recordPayment(result.customerId, result.amount, result.method);
          renderPayments();
          renderUnpaid();
          await showAlert('Payment added successfully!', 'Success');
        } catch (err) {
          await showAlert(`Failed to add payment: ${err.message}`, 'Error');
        }
      }
    });
  </script>
</body>

</html>